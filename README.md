# Simple Load Balancer

Go μ–Έμ–΄λ΅ μ‘μ„±λ κ°„λ‹¨ν• HTTP λ΅λ“ λ°Έλ°μ„(Load Balancer)μ…λ‹λ‹¤.  
μ—¬λ¬ λ°±μ—”λ“ μ„λ²„λ΅ νΈλν”½μ„ λ¶„μ‚°μ‹ν‚¤λ©°(Round-Robin), μ£ΌκΈ°μ μΈ ν—¬μ¤ μ²΄ν¬(Health Check)λ¥Ό ν†µν•΄ κ±΄κ°•ν• μ„λ²„λ΅λ§ μ”μ²­μ„ μ „λ‹¬ν•©λ‹λ‹¤.

## β¨ μ£Όμ” κΈ°λ¥

- **λ΅λ“ λ°Έλ°μ‹±**: λ“¤μ–΄μ¤λ” HTTP μ”μ²­μ„ μ„¤μ •λ λ°±μ—”λ“ μ„λ²„λ“¤λ΅ μμ°¨μ μΌλ΅ λ¶„μ‚°ν•©λ‹λ‹¤ (Round-Robin).
- **ν—¬μ¤ μ²΄ν¬ (Health Check)**:
  - μ£ΌκΈ°μ μΌλ΅(κΈ°λ³Έ 5μ΄) λ°±μ—”λ“ μ„λ²„μ μƒνƒλ¥Ό ν™•μΈν•©λ‹λ‹¤.
  - μ‘λ‹µν•μ§€ μ•λ” μ„λ²„λ” λ΅λ“ λ°Έλ°μ‹± λ€μƒμ—μ„ μλ™μΌλ΅ μ μ™Έλ©λ‹λ‹¤.
  - μ„λ²„κ°€ λ‹¤μ‹ λ³µκµ¬λλ©΄ μλ™μΌλ΅ λ€μƒμ— ν¬ν•¨λ©λ‹λ‹¤.
- **Hot Reload (ν•« λ¦¬λ΅λ“)**:
  - μ„λ²„λ¥Ό μ¤‘λ‹¨ν•μ§€ μ•κ³  μ„¤μ • νμΌ(`config.yaml`)μ„ μμ •ν•μ—¬ λ°±μ—”λ“ μ„λ²„ λ©λ΅μ„ μ‹¤μ‹κ°„μΌλ΅ λ°μν•  μ μμµλ‹λ‹¤.
- **CLI λ…λ Ήμ–΄ μ§€μ›**:
  - μ‹¤ν–‰, μ„¤μ • λ¦¬λ΅λ“, μ¤‘λ‹¨ λ“± ν”„λ΅μ„Έμ¤ μ μ–΄λ¥Ό μ„ν• μ»¤λ§¨λ“λΌμΈ ν”λκ·Έλ¥Ό μ κ³µν•©λ‹λ‹¤.
- **μ„¤μ • νμΌ μ§€μ›**: `config.yaml` νμΌμ„ ν†µν•΄ ν¬νΈ, μ „λµ, λ°±μ—”λ“ μ„λ²„ λ©λ΅μ„ μ‰½κ² λ³€κ²½ν•  μ μμµλ‹λ‹¤.
- **ν…μ¤νΈ ν™κ²½ μ κ³µ**: λ΅λ“ λ°Έλ°μ‹± λ™μ‘μ„ μ‰½κ² ν™•μΈν•  μ μλ” λ”λ―Έ μ„λ²„ μ¤ν¬λ¦½νΈ(`dummy_servers.go`)λ¥Ό ν¬ν•¨ν•κ³  μμµλ‹λ‹¤.

## π€ μ‹μ‘ν•κΈ° (Getting Started)

### 1. μ „μ  μ΅°κ±΄ (Prerequisites)
- [Go](https://go.dev/)κ°€ μ„¤μΉλμ–΄ μμ–΄μ•Ό ν•©λ‹λ‹¤.

### 2. μ„¤μΉ λ° μ‹¤ν–‰

#### 1) λ”λ―Έ μ„λ²„ μ‹¤ν–‰ (Optional)
λ΅μ»¬μ—μ„ ν…μ¤νΈν•κΈ° μ„ν•΄ 3κ°μ λ°±μ—”λ“ μ„λ²„(Port: 9001, 9002, 9003)λ¥Ό μ‹¤ν–‰ν•©λ‹λ‹¤.
μƒ ν„°λ―Έλ„μ„ μ—΄κ³  λ‹¤μ λ…λ Ήμ–΄λ¥Ό μ‹¤ν–‰ν•μ„Έμ”.

```bash
go run dummy_servers.go
```

#### 2) λ΅λ“ λ°Έλ°μ„ μ‹¤ν–‰
λ‹¤λ¥Έ ν„°λ―Έλ„μ—μ„ λ΅λ“ λ°Έλ°μ„λ¥Ό μ‹¤ν–‰ν•©λ‹λ‹¤. κΈ°λ³Έμ μΌλ΅ 8000λ² ν¬νΈμ—μ„ μ‹¤ν–‰λ©λ‹λ‹¤.

```bash
go run cmd/main.go
```
λλ” μ»¤μ¤ν…€ μ„¤μ • νμΌμ„ μ§€μ •ν•μ—¬ μ‹¤ν–‰ν•  μ μμµλ‹λ‹¤.
```bash
go run cmd/main.go -config my-config.yaml
```

### 3. κ΄€λ¦¬ λ…λ Ήμ–΄ (Management Commands)

λ΅λ“ λ°Έλ°μ„κ°€ λ°±κ·ΈλΌμ΄λ“λ‚ λ‹¤λ¥Έ ν„°λ―Έλ„μ—μ„ μ‹¤ν–‰ μ¤‘μΌ λ•, λ‹¤μ λ…λ Ήμ–΄λ΅ μ μ–΄ν•  μ μμµλ‹λ‹¤.

- **μ„¤μ • λ¦¬λ΅λ“ (Hot Reload)**:
  `config.yaml`μ„ μμ •ν• ν›„ μ•„λ λ…λ Ήμ–΄λ¥Ό μ‹¤ν–‰ν•λ©΄, μ„λ²„ μ¤‘λ‹¨ μ—†μ΄ λ³€κ²½ μ‚¬ν•­μ΄ λ°μλ©λ‹λ‹¤.
  ```bash
  go run cmd/main.go -reload
  ```

- **μ„λ²„ μ¤‘μ§€ (Stop)**:
  μ‹¤ν–‰ μ¤‘μΈ λ΅λ“ λ°Έλ°μ„λ¥Ό μ°μ•„ν•κ²(Gracefully) μΆ…λ£ν•©λ‹λ‹¤.
  ```bash
  go run cmd/main.go -stop
  ```

### 4. λ™μ‘ ν™•μΈ
λΈλΌμ°μ €λ‚ `curl` λ…λ Ήμ–΄λ¥Ό ν†µν•΄ λ΅λ“ λ°Έλ°μ„μ— μ”μ²­μ„ λ³΄λ‚΄ λ™μ‘μ„ ν™•μΈν•©λ‹λ‹¤.

```bash
curl http://localhost:8000
```
μ—¬λ¬ λ² μ”μ²­μ„ λ³΄λ‚΄λ©΄, μ‹¤ν–‰ μ¤‘μΈ λ°±μ—”λ“ μ„λ²„λ“¤λ΅ μ”μ²­μ΄ λ²κ°μ•„κ°€λ©° μ „λ‹¬λλ” κ²ƒμ„ ν™•μΈν•  μ μμµλ‹λ‹¤.

## β™οΈ μ„¤μ • (Configuration)

`config.yaml` νμΌμ—μ„ μ„¤μ •μ„ λ³€κ²½ν•  μ μμµλ‹λ‹¤.

```yaml
# λ΅λ“ λ°Έλ°μ„κ°€ μ‹¤ν–‰λ  ν¬νΈ
port: ":8000"

# λ΅λ“ λ°Έλ°μ‹± μ „λµ (ν„μ¬ Round-Robin λ™μ‘)
strategy: "round-robin"

# νΈλν”½μ„ λ¶„μ‚°ν•  λ°±μ—”λ“ μ„λ²„ λ©λ΅
backends:
  - "http://localhost:9001"
  - "http://localhost:9002"
  - "http://localhost:9003"
```

## π“ μ„±λ¥ ν…μ¤νΈ κ²°κ³Ό (Performance Benchmark)

`hey` λ„κµ¬λ¥Ό μ‚¬μ©ν•μ—¬ λ΅λ“ λ°Έλ°μ„μ μ„±λ¥μ„ ν…μ¤νΈν• κ²°κ³Όμ…λ‹λ‹¤.

### Scenario 1: κΈ°λ³Έ μ„±λ¥ ν…μ¤νΈ (Basic Performance)
κΈ°λ³Έμ μΈ μ”μ²­ μ²λ¦¬ μ„±λ¥μ„ μΈ΅μ •ν•©λ‹λ‹¤. (Total 2000 requests, 50 concurrent)

```bash
hey -n 2000 -c 50 http://localhost:8000
```

**Result Summary:**
```text
Summary:
  Total:        0.1146 secs
  Slowest:      0.0131 secs
  Fastest:      0.0001 secs
  Average:      0.0028 secs
  Requests/sec: 17448.5241
  
  Total data:   124000 bytes
  Size/request: 62 bytes

Response time histogram:
  0.000 [1]     |
  0.001 [427]   |β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– 
  0.003 [753]   |β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– 
  0.004 [485]   |β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– 
  0.005 [197]   |β– β– β– β– β– β– β– β– β– β– 
  0.007 [58]    |β– β– β– 
  0.008 [22]    |β– 
  0.009 [14]    |β– 
  0.011 [14]    |β– 
  0.012 [20]    |β– 
  0.013 [9]     |


Latency distribution:
  10% in 0.0009 secs
  25% in 0.0015 secs
  50% in 0.0023 secs
  75% in 0.0035 secs
  90% in 0.0048 secs
  95% in 0.0061 secs
  99% in 0.0116 secs

Details (average, fastest, slowest):
  DNS+dialup:   0.0001 secs, 0.0001 secs, 0.0131 secs
  DNS-lookup:   0.0001 secs, 0.0000 secs, 0.0027 secs
  req write:    0.0000 secs, 0.0000 secs, 0.0009 secs
  resp wait:    0.0026 secs, 0.0001 secs, 0.0098 secs
  resp read:    0.0001 secs, 0.0000 secs, 0.0010 secs

Status code distribution:
  [200] 2000 responses
```

### Scenario 2: Hot Reload μ•μ •μ„± ν…μ¤νΈ (Stability during Hot Reload)
νΈλν”½μ΄ μ§€μ†μ μΌλ΅ λ“¤μ–΄μ¤λ” μƒν™©(10μ΄κ°„ λ¶€ν•)μ—μ„ `config.yaml`μ λ°±μ—”λ“ μ„λ²„ ν•λ‚(Port 9002)λ¥Ό μ κ±°ν•κ³  `Configuration Reload`λ¥Ό μν–‰ν–μ„ λ•μ μ•μ •μ„±μ„ ν…μ¤νΈν–μµλ‹λ‹¤.

**κ²°κ³Ό: μ—λ¬μ¨ 0% (λ¨λ“  μ”μ²­ 200 OK μ²λ¦¬)**

```bash
hey -z 10s -c 50 http://localhost:8000
```

**Result Summary:**
```text
Summary:
  Total:        10.0199 secs
  Slowest:      0.1059 secs
  Fastest:      0.0001 secs
  Average:      0.0083 secs
  Requests/sec: 6014.4112
  
  Total data:   3736368 bytes
  Size/request: 62 bytes

Response time histogram:
  0.000 [1]     |
  0.011 [41660] |β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– β– 
  0.021 [11454] |β– β– β– β– β– β– β– β– β– β– β– 
  0.032 [5849]  |β– β– β– β– β– β– 
  0.042 [1068]  |β– 
  0.053 [97]    |
  0.064 [44]    |
  0.074 [62]    |
  0.085 [21]    |
  0.095 [5]     |
  0.106 [3]     |


Latency distribution:
  10% in 0.0010 secs
  25% in 0.0017 secs
  50% in 0.0034 secs
  75% in 0.0137 secs
  90% in 0.0224 secs
  95% in 0.0270 secs
  99% in 0.0352 secs

Details (average, fastest, slowest):
  DNS+dialup:   0.0000 secs, 0.0001 secs, 0.1059 secs
  DNS-lookup:   0.0000 secs, 0.0000 secs, 0.0021 secs
  req write:    0.0000 secs, 0.0000 secs, 0.0005 secs
  resp wait:    0.0083 secs, 0.0001 secs, 0.1058 secs
  resp read:    0.0000 secs, 0.0000 secs, 0.0006 secs

Status code distribution:
  [200] 60264 responses
```

**Traffic Distribution Change Log:**
μ„λ²„ λ΅κ·Έλ¥Ό ν†µν•΄ νΈλν”½ λ¶„μ‚°μ΄ μ‹¤μ‹κ°„μΌλ΅ λ³€κ²½λλ” κ²ƒμ„ ν™•μΈν–μµλ‹λ‹¤.

**Before Reload (3 Servers)**:
`Server 2`κ°€ ν¬ν•¨λ μƒνƒλ΅ νΈλν”½μ΄ λ¶„μ‚°λ©λ‹λ‹¤.
```text
[Server 2] μ”μ²­ λ°›μ!
[Server 3] μ”μ²­ λ°›μ!
[Server 2] μ”μ²­ λ°›μ!
[Server 1] μ”μ²­ λ°›μ!
[Server 1] μ”μ²­ λ°›μ!
[Server 3] μ”μ²­ λ°›μ!
[Server 1] μ”μ²­ λ°›μ!
```

**After Reload (2 Servers, Server 2 removed)**:
`Server 2` μ κ±° ν›„, νΈλν”½μ΄ `Server 1`κ³Ό `Server 3`μΌλ΅λ§ λ¶„μ‚°λ©λ‹λ‹¤.
```text
[Server 3] μ”μ²­ λ°›μ!
[Server 1] μ”μ²­ λ°›μ!
[Server 3] μ”μ²­ λ°›μ!
[Server 1] μ”μ²­ λ°›μ!
[Server 3] μ”μ²­ λ°›μ!
[Server 1] μ”μ²­ λ°›μ!
```
Hot Reload μ μ© μ¦‰μ‹ μƒλ΅μ΄ μ„¤μ •μ΄ λ°μλμ–΄, μ„λΉ„μ¤ μ¤‘λ‹¨ μ—†μ΄ μ μ—°ν•κ² μ„λ²„λ¥Ό κ΄€λ¦¬ν•  μ μμµλ‹λ‹¤.


## π“‚ ν”„λ΅μ νΈ κµ¬μ΅°

```
simple-lb/
β”β”€β”€ cmd/
β”‚   β””β”€β”€ main.go           # ν”„λ΅κ·Έλ¨ μ—”νΈλ¦¬ ν¬μΈνΈ
β”β”€β”€ config/
β”‚   β””β”€β”€ config.go         # μ„¤μ • νμΌ λ΅λ“ λ° νμ‹± λ΅μ§
β”β”€β”€ proxy/
β”‚   β””β”€β”€ lb.go             # λ΅λ“ λ°Έλ°μ„ ν•µμ‹¬ λ΅μ§ (ReverseProxy, HealthCheck)
β”β”€β”€ config.yaml           # μ„¤μ • νμΌ
β”β”€β”€ dummy_servers.go      # ν…μ¤νΈμ© λ”λ―Έ λ°±μ—”λ“ μ„λ²„
β””β”€β”€ README.md             # ν”„λ΅μ νΈ μ„¤λ…μ„
```
